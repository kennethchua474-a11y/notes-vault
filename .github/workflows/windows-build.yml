name: Windows Release Build

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Poetry
        run: pip install poetry

      - name: Install dependencies
        run: poetry install --no-interaction --no-root

      # Extract version
      - name: Extract version
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart("v")
          echo "VERSION=$version" >> $env:GITHUB_ENV

      # Generate version file safely
      - name: Generate Windows version file
        shell: pwsh
        run: |
          $v = $env:VERSION
          $parts = $v.Split(".")
          $major = $parts[0]
          $minor = $parts[1]
          $patch = $parts[2]

          $content = @"
VSVersionInfo(
  ffi=FixedFileInfo(
    filevers=($major,$minor,$patch,0),
    prodvers=($major,$minor,$patch,0),
    mask=0x3f,
    flags=0x0,
    OS=0x40004,
    fileType=0x1,
    subtype=0x0,
    date=(0, 0)
  ),
  kids=[
    StringFileInfo([
      StringTable(
        '040904B0',
        [
          StringStruct('CompanyName', 'Kenneth Chua'),
          StringStruct('FileDescription', 'Personal Notes Vault'),
          StringStruct('FileVersion', '$v'),
          StringStruct('InternalName', 'NotesVault'),
          StringStruct('OriginalFilename', 'NotesVault.exe'),
          StringStruct('ProductName', 'NotesVault'),
          StringStruct('ProductVersion', '$v')
        ]
      )
    ]),
    VarFileInfo([VarStruct('Translation', [1033, 1200])])
  ]
)
"@
          $content | Out-File version.txt -Encoding utf8

      # Build exe
      - name: Build EXE
        shell: pwsh
        run: poetry run pyinstaller --onefile --windowed --name NotesVault --icon assets/icon.ico --version-file version.txt notes_app/gui.py

      # Prepare release output
      - name: Prepare release folder
        shell: pwsh
        run: |
          mkdir release
          Copy-Item dist/NotesVault.exe release/NotesVault-$env:VERSION.exe

      # Create ZIP
      - name: Create ZIP
        shell: pwsh
        run: |
          Compress-Archive -Path release/NotesVault-$env:VERSION.exe -DestinationPath release/NotesVault-$env:VERSION.zip

      # Create GitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/NotesVault-${{ env.VERSION }}.zip

