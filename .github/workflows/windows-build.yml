name: Windows Release Build

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Poetry
        run: pip install poetry

      - name: Install dependencies
        run: poetry install --no-interaction --no-root

      - name: Install PyInstaller
        run: poetry add --group dev pyinstaller

      # Extract version from tag
      - name: Extract version
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart("v")
          echo "VERSION=$version" >> $env:GITHUB_ENV

      # Generate version.txt using Python (YAML-safe)
      - name: Generate version file
        run: |
          python - <<EOF
import os

v = os.environ["VERSION"]
major, minor, patch = v.split(".")

content = f"""VSVersionInfo(
  ffi=FixedFileInfo(
    filevers=({major},{minor},{patch},0),
    prodvers=({major},{minor},{patch},0),
    mask=0x3f,
    flags=0x0,
    OS=0x40004,
    fileType=0x1,
    subtype=0x0,
    date=(0, 0)
  ),
  kids=[
    StringFileInfo([
      StringTable(
        '040904B0',
        [
          StringStruct('CompanyName', 'Kenneth Chua'),
          StringStruct('FileDescription', 'Personal Notes Vault'),
          StringStruct('FileVersion', '{v}'),
          StringStruct('InternalName', 'NotesVault'),
          StringStruct('OriginalFilename', 'NotesVault.exe'),
          StringStruct('ProductName', 'NotesVault'),
          StringStruct('ProductVersion', '{v}')
        ]
      )
    ]),
    VarFileInfo([VarStruct('Translation', [1033, 1200])])
  ]
)
"""

with open("version.txt", "w", encoding="utf-8") as f:
    f.write(content)
EOF

      - name: Build EXE
        run: |
          poetry run pyinstaller ^
            --onefile ^
            --windowed ^
            --name NotesVault ^
            --icon assets/icon.ico ^
            --version-file version.txt ^
            notes_app/gui.py

      - name: Prepare release folder
        shell: pwsh
        run: |
          mkdir release
          Copy-Item dist\NotesVault.exe release\NotesVault-$env:VERSION.exe

      - name: Create ZIP
        shell: pwsh
        run: |
          Compress-Archive `
            release\NotesVault-$env:VERSION.exe `
            release\NotesVault-$env:VERSION.zip

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/NotesVault-${{ env.VERSION }}.zip

